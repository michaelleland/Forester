<div id="entry_form">
	<form action="/add_ticket_entry_row" method="post" data-remote="true">
		<h4>New Entry</h4>
		<table id="entry_table">
			<tr>
				<th>Ticket #</th>
				<th>Date</th>
				<th>Job</th>
				<th>Destination</th>
				<th>Wood type</th>
				<th>Species</th>
				<th>Tonnage</th>
				<th>MBF</th>
				<th>Net MBF</th>
				<th>Load pay</th>
				<th>Action</th>
			</tr>
			<tr>
				<td>
					<input id="ticket_num" type="text" name="ticket_num" size="5" class="fields"/>
					<script>$('#ticket_num').mask('9999', {placeholder: " "})</script>
				</td>
				<td>
					<input type="text" name="delivery_date" id="delivery_date" size="8" class="fields"/>
					<script> $('#delivery_date').datepicker({ dateFormat: 'yy-mm-dd'}); $('#delivery_date').mask("9999-99-99", {placeholder: " "}); </script>
				</td>
				<td>
					<input type="text" id="job_name" name="job_name" size="12" class="fields"/>
					<script> 
						$(function() {
							var jobs = [
								<% @jobs.each do |i| %>
									<%= "'#{i.name}'," %>
								<% end %>
							];
													
							$('#job_name').autocomplete({ 
								source: jobs,
								delay: 50,
								autoFocus: true
							});
						});
					</script>
				</td>
				<td>
					<input type="text" id="destination_name" name="destination_name" size="15" class="fields" />
					<script> 
						$(function() {
							var destinations = [
								<% @destinations.each do |i| %>
									<%= "'#{i.name}'," %>
								<% end %>
							];
													
							$('#destination_name').autocomplete({ 
								source: destinations,
								delay: 50,
								autoFocus: true
							});
						});
					</script>
				</td>
				<td>
					<select id="wood_type" name="wood_type">
						<% WoodType.all.each do |i| %>
							<option value="<%= i.id %>"><%= i.name %></option>
						<% end %>					
					</select>
				</td>
				<td>
					<select class="specie_selector" name="species_1">
						<% Specie.all.each do |i| %>
							<option value="<%= i.id %>"><%= i.code %></option>
						<% end %>
						<option value="0">Pulp</option>
					</select>
				</td>
				<td>
					<input type="text" id="tonnage" size="8" name="tonnage" disabled="true" class="fields"/>
				</td>
				<td>
					<input id="load_1_mbfs" class="specie_mbfs" type="text" size="8" disabled="true" onchange="refresh_net_mbf('load_1_mbfs')" name="load_1_mbfs" class="fields"/>
				</td>
				<td>
					<input id="net_mbf" type="text" size="8" value="0" name="net_mbf" disabled="true" class="fields"/>
				</td>
				<td>
					<input id="value" type="text" size="8" name="value" class="fields"/>
				</td>
				<td>
					<input  style="display: none;" id="submit_button" type="submit" value="Submit" onclick="change_button();" />
					<input id="check_button" type="button" value="Check" onclick="check_field_data();" />
				</td>
			</tr>
			<tr id="filler_row">
				<td id="Incredible_invisible_text">You</td>
				<td id="Incredible_invisible_text">have</td>
				<td id="Incredible_invisible_text">just</td>	
				<td id="Incredible_invisible_text">been</td>
				<td id="Incredible_invisible_text">tagged</td>
				<td><%= link_to "Add", {:controller => "page_controls", :action => "add_specie"}, :remote => true, :id => "add_specie_button"%></td>			
			</tr>
		</table>
	</form>
</div>

<div id="current_entries">
	<h4>Current Entries</h4>
	
	<table>
		<tr>
			<th style="width: 50px;">Ticket #</th>
			<th style="width: 80px;">Date</th>
			<th style="width: 100px;">Job</th>
			<th style="width: 100px;">Destination</th>
			<th style="width: 80px;">Wood type</th>
			<th style="width: 60px;">Species</th>
			<th style="width: 60px;">Net MBF</th>
			<th style="width: 60px;">Tonnage</th>
			<th style="width: 80px;">Load pay</th>
			<th style="width: 40px;">Action</th>
		</tr>
		
	</table>
	
</div>

<div id="all_entries">
	<h4>All Entries</h4>
	<table>
		<tr>
			<th style="width: 50px;">Ticket #</th>
			<th style="width: 80px;">Date</th>
			<th style="width: 100px;">Job</th>
			<th style="width: 100px;">Destination</th>
			<th style="width: 80px;">Wood type</th>
			<th style="width: 60px;">Species</th>
			<th style="width: 60px;">Net MBF</th>
			<th style="width: 60px;">Tonnage</th>
			<th style="width: 80px;">Load pay</th>
			<th style="width: 40px;">Action</th>
		</tr>
		
	</table>

	
	<script>
		
		/* At this point, this function makes sure that all fields have a value. Disabled fields are not included.
		 * This is called by Check-button only. Does not validate the data in any way, yet.
		 */
		
		function check_field_data() {
			var values = [];
			values.push([$('#ticket_num').attr('value'), 'Ticket number']);
			values.push([$('#delivery_date').attr('value'), 'Delivery date']);
			values.push([$('#job_name').attr('value'), 'Job']);
			values.push([$('#destination_name').attr('value'), 'Destination']);
			if ($('#tonnage').attr('disabled') == undefined) {
				values.push([$('#tonnage').attr('value'), 'Tonnage']);
			} else {
				if ($('#net_mbf').attr('disabled') == undefined) {
					values.push([$('#net_mbf').attr('value'), 'Net MBF']);
				}
			}
			values.push([$('#value').attr('value'), 'Ticket value']);
			
			$('#entry_form table').after('<div id="feedback" style="color: red;"></div>');
			
			var everything_ok = true;
			
			for (i=0;i<values.length;i++) {
				if (values[i][0] == "") {
					$('#feedback').append('<div>'+values[i][1]+' missing </div>');
					everything_ok = false; 
				}
			}
			
			setTimeout(function() {
				$('#feedback').fadeOut();
				setTimeout(function() {
					$('#feedback').remove();
				}, 620);
			}, 3000);
			
			if (everything_ok) {
				$('#check_button').attr('style', 'display: none;');
				$('#submit_button').attr('style', 'display: block;');
			}	
		}
		
		function change_button () {
			$('#submit_button').attr('style', 'display: none;');
			$('#check_button').attr('style', 'display: block;');
		}
		
		/* When destination fields value changes, this function enables Tonnage/MBf fields according to the  
		 * trucker/logger rates in this job / destination combination. 
		 */
		
		$('#destination_name').change(function () {
			$('.specie_mbfs').each(function(){$(this).attr('disabled', 'true');});
			$('#tonnage').attr('disabled', 'true');
			
			var job_name = $('#job_name').attr('value');
			var destination_name = $('#destination_name').attr('value');
			
			if (job_name != "" && destination_name != "") {
				$.ajax({
					url: "/get_load_type/?job_name="+job_name+"&destination_name="+destination_name,
					cache: false,
					success: function (html) {
						if (html == "MBF") {
							$('.specie_mbfs').each(function(){$(this).removeAttr('disabled');});
						} else if (html == "Tonnage") {
							$('#tonnage').removeAttr('disabled');
						} else if (html == "Both") {
							$('.specie_mbfs').each(function(){$(this).removeAttr('disabled');});
							$('#tonnage').removeAttr('disabled');
						}
					}
				});
			} 
		});
		
		/* All the load_1_mbf, load_2_mbf etc have onchange event ponting to this function.
		 * This function takes values from those (they give themselves as parameter) and adds it up
		 * and puts it  to net_mbf field.
 		 */
		
		
		function refresh_net_mbf(where_from) {
			amount = 0;
			
			<% Specie.all.each do |i| %>
				if (String(parseFloat($('#load_'+<%= i.id %>+'_mbf').attr('value'))) != "NaN") {
					amount = amount + parseFloat($('#load_'+<%= i.id %>+'_mbf').attr('value'));
				}
			<% end %>
			
			$('#net_mbf').attr('value', amount);
		}
		
		function delete_ticket_entry(id) {
			if (confirm("Are you sure you want to delete this ticket?")) {
				$.ajax ({
					url: "/delete_ticket_entry/"+id,
					cache: false,
					success: function() {
						$('#current_entries').find('#'+id+'entry').fadeOut();
						setTimeout(function() {
							$('#current_entries').find('#'+id+'entry').remove();
						}, 620);
					
						$('#all_entries').find('#'+id+'entry').fadeOut();
						setTimeout(function() {
							$('#all_entries').find('#'+id+'entry').remove();
						}, 620);
					}
				});
			}
			
		}
		
		/* Script to be run on every pageload */
		refresh_all_entries('ticket');
		
		
	</script>
</div>